#!/bin/bash
echo "======================================"
echo "Job C started"
echo "DEPLOY_ENV        : $DEPLOY_ENV"
echo "MANUAL_APPROVAL   : $MANUAL_APPROVAL"
echo "UPSTREAM RESULT   : $UPSTREAM_BUILD_RESULT"
echo "======================================"

# UPSTREAM FAILURE HANDLING
if [ "$UPSTREAM_BUILD_RESULT" = "FAILURE" ]; then
  echo "Upstream Job B FAILED."
  echo "Waiting up to 30 seconds for manual approval..."
  APPROVED=false
  for i in {1..3}; do
    if [ "$MANUAL_APPROVAL" = "true" ]; then
      APPROVED=true
      echo "Manual approval RECEIVED for upstream failure."
      break
    fi
    echo "Approval not yet given... checking again in 10 seconds"
    sleep 10
  done

  if [ "$APPROVED" != "true" ]; then
    echo "Manual approval NOT received within 30 seconds."
    echo "Job C aborted due to upstream failure."
    exit 1
  fi

  echo "Continuing Job C after upstream approval."
fi

# ENVIRONMENT SELECTION
case "$DEPLOY_ENV" in
  dev)
    echo "Deploying to Development"
    ;;
  stage)
    echo "Deploying to Staging"
    ;;
  prod)
    echo "Deploying to Production"
    echo "Production deployment requires manual approval"
    if [ "$MANUAL_APPROVAL" != "true" ]; then
      echo "Production approval NOT provided."
      echo "Deployment aborted."
      exit 1
    fi
    echo "Manual approval confirmed for Production deployment"
    ;;
  *)
    echo "Invalid DEPLOY_ENV value"
    exit 1
    ;;
esac

# DEPLOYMENT EXECUTION
echo "======================================"
echo "Executing Job C Deployment"
sleep 3
echo "Deployment completed successfully"
echo "======================================"

